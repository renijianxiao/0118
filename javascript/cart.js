require(["lib/jquery/1.11.1/jquery-1.11.1","lib/template","lib/json/json3.min"],function(e,t,n){function d(){return i?b:w}function v(e){if(!e.sendData)return alert("添加商品不能为空哦！"),!1;var t={};t=$.extend({beforeSend:function(){},done:function(e){e.stauts==1?alert("加入成功!"):alert(e.msg)},fail:function(){alert("服务请求错误，请稍后再试或联系客服！")},always:function(){}},e||{}),t.sendData.return_cart_data=!1,t.sendData=$.extend({},o,t.sendData),$.ajax({url:s+"cartApi/addList",dataType:"jsonp",cache:!1,data:{source:window.location.toString(),data:JSON.stringify(t.sendData)},beforeSend:t.beforeSend}).done(t.done).done(function(e){(e.status==1||e.status==2)&&p.viewEvent.miniCartViewNum(e)}).fail(t.fail).always(t.always)}function m(e){if(!e.sendData)return alert("修改商品不能为空哦！"),!1;var t={};t=$.extend({beforeSend:function(){},done:function(e){},fail:function(){alert("服务请求错误，请稍后再试或联系客服！")},always:function(){}},e||{}),t.sendData=$.extend({},o,t.sendData);var n=(new Date).getTime();$.ajax({url:s+"cartApi/modifyList?timestamp="+n,dataType:"jsonp",cache:!1,data:{data:JSON.stringify(t.sendData)},beforeSend:t.beforeSend}).done(t.done).done(function(e){p.viewEvent.miniCartView(e),e.status==2?alert(e.msg):e.status==3&&alert("修改失败！")}).fail(t.fail).always(t.always)}function g(e){if(!e.sendData)return alert("删除商品不能为空哦！"),!1;var t={};t=$.extend({beforeSend:function(){},done:function(e){},fail:function(){alert("服务请求错误，请稍后再试或联系客服！")},always:function(){}},e||{}),t.sendData=$.extend({},o,t.sendData);var n=(new Date).getTime();$.ajax({url:s+"cartApi/deleteList?timestamp="+n,dataType:"jsonp",cache:!1,data:{data:JSON.stringify(t.sendData)},beforeSend:t.beforeSend}).done(t.done).done(function(e){p.viewEvent.miniCartView(e),e.status==2?alert(e.msg):e.status==3&&alert("删除失败！")}).fail(t.fail).always(t.always)}function y(e){if($.isPlainObject(e))var t=e;else var t=$.parseJSON(e);var e={product_list:[]},n=[],r={kind:1,type:0,sm_seq:t.s,parent_seq:"",qty:t.q,campaign_seq:t.campaign_seq==="undefined"?"":t.campaign_seq};n.push(r);if(!$.isEmptyObject(t.g))for(var i=0;i<t.g.length;i++)n.push({kind:2,type:0,sm_seq:t.g[i].i,parent_seq:t.s,qty:t.g[i].q,campaign_seq:""});if(!$.isEmptyObject(t.p))for(var s=0;s<t.p.length;s++)n.push({kind:3,type:0,sm_seq:t.p[s].i,parent_seq:t.s,qty:t.p[s].q,campaign_seq:""});if(!$.isEmptyObject(t.m))for(var o=0;o<t.m.length;o++)n.push({kind:6,type:0,sm_seq:t.m[o].i,parent_seq:t.s,qty:1,campaign_seq:""});return e.product_list.push(n),e}typeof www_domain_sub=="undefined"?myDomain=".feiniu.com":myDomain=www_domain_sub;var r=!1,i=!1;typeof GLOBAL_LOAD_CART!="undefined"&&(i=!0);var s="//buy"+myDomain+"/",o={cart_type:0,is_simple:!0,return_cart_data:!0};i&&(o=$.extend(o,{version:1}));var u="http:"+s+"cart/index",a={},f=0,l=0,c,h,p={regular:{pint:/^[0-9]\d*$/,kznum:9},init:function(){p.bindEvents(),p.viewEvent.sdboxMiniCartRightHeight(),p.viewEvent.setNewScrollTop()},bindEvents:function(){$("#minicart .js_no_camp_list").find(".ul_activity").length>0&&$("#minicart .js_no_camp_list").find(".ul_activity").next().css("border-top","0 none"),$(".minicartContent").delegate(".js_mini_num a","click",p.EventList.addOrMinus),$(".minicartContent").delegate(".js_mini_num input","change",p.EventList.changeCount),$(".minicartContent").delegate(".js_delete","click",p.EventList.deletePro)},utils:{getCookie:function(e){var t=new RegExp("(^| )"+e+"(?:=([^;]*))?(;|$)"),n=document.cookie.match(t);return n?n[2]?unescape(n[2]):"":null}},EventList:{getSpecialQty:function(e){if(a[e].kind==8){var t=a[e].cart_detail_parent_id;return a[t].qty}var n=0;return $.each(a,function(t,r){r.cart_detail_parent_id==e&&r.kind==8&&(n=r.qty)}),n},getSpecialCartId:function(e){return a[e].kind==8?a[e].cart_detail_parent_id:e},addOrMinus:function(e){var t=$(e.currentTarget),n=t.parents(".js_cart_pro_list"),r=n.attr("cart_id"),i=t.siblings("input"),s=parseInt(i.data("limit")),o=parseInt(i.val())+parseInt(t.attr("data-value")),u=a[r].disable_reason||0,f=a[r].is_prize||0,l=a[r].kind||0;if(u>0||f==1||l==15)return!1;if(o<1)return i.val(1),!1;if(o>s)return i.val(s),!1;p.EventList.updNumUi(i,n,o,s,300,e)},changeCount:function(e){var t=$(this),n=t.parents(".js_cart_pro_list"),r=n.attr("cart_id"),i=t.val(),s=parseInt(t.data("limit")),o=a[r].disable_reason||0,u=a[r].is_prize||0,f=a[r].kind||1;if(o>0||u==1||f==15)return!1;i.match(p.regular.pint)?(i=parseInt(i),p.EventList.updNumUi(t,n,i,s,0,e)):t.val(a[r].qty)},deletePro:function(e){var t=$(this),n=t.parents(".js_cart_pro_list"),r=n.attr("cart_id"),i=a[r];p.viewEvent.getNewScrollTop(e);if(a[r].source_sell>0||a[r].kind==8)r=p.EventList.getSpecialCartId(r);var s={cart_detail_ids:[r],cart_detail_qty:[]};s.cart_detail_qty.push({cart_detail_id:r,qty:i.qty});var o={sendData:s};g(o)},abnormalDisplay:function(e,t){var n=$(t.currentTarget),r=n.siblings("input"),i=n.parents(".mini_op");if(i.length&&!i.find(".cl-xg").length){var s=$('<span class="cl-xg">'+e+'<i class="icon-triangle-02"></i></span>');i.append(s),s.show(100),setTimeout(function(){s.remove()},2e3)}},updNumUi:function(e,t,n,r,i,s){var o=!0,u=t.attr("cart_id");n<1&&(n=a[u].qty,o=!1),e.val(n);if(a[u].source_sell>0||a[u].kind==8)n+=p.EventList.getSpecialQty(u),u=p.EventList.getSpecialCartId(u);if(r>0&&n>r){if(!t.find(".cl-xg").length){var f="最多可购"+r+"件";p.EventList.abnormalDisplay(f,s)}n=r}n==1?t.find(".mini_num a").eq(0).addClass("reduce_gray"):n==r?t.find(".mini_num a").eq(1).addClass("add_gray"):n>1&&n<r&&t.find(".mini_num a").removeClass("reduce_gray add_gray"),o===!0?p.EventList.updNumModify(e,t,u,n,i,s):e.val(n)},updNumModify:function(e,t,n,r,i,s){clearTimeout(h),h=setTimeout(function(){var e=[];p.viewEvent.getNewScrollTop(s),e.push({cart_detail_id:n,qty:r,selected:!0,campaign_seq:null});var t={cart_detail_list:e},i={sendData:t};m(i)},i)}},ajaxEvent:{showMiniCart:function(){var e=(new Date).getTime();$.ajax({url:s+"cartApi/getAll?timestamp="+e,dataType:"jsonp",data:{data:JSON.stringify(o)},success:function(e){p.viewEvent.miniCartView(e)}})},showMiniCartNum:function(){var e=(new Date).getTime();$.ajax({url:s+"cartApi/getMiniCartSum?timestamp="+e,dataType:"jsonp",data:{data:JSON.stringify(o)},success:function(e){p.viewEvent.miniCartViewNum(e)}})}},viewEvent:{sdboxMiniCartRightHeight:function(){if($("#miniCartRight").length>0){var e=$(window).height(),t=$(".J-sdb"),n=0;t.hasClass("m-sdb-sale")?n=e-337:n=e-137,$(".J-sdb-cb").css("height",n+"px")}},getNewScrollTop:function(e){$(e.currentTarget).parents("#miniCartRight").length>0?(f=$("#miniCartRight").find(".js_cart_top").scrollTop(),l=1):(f=$("#hd-my-cart").find(".js_cart_top").scrollTop(),l=0)},setNewScrollTop:function(){l==0?$("#hd-my-cart").find(".js_cart_top").scrollTop(f):$("#miniCartRight").find(".js_cart_top").scrollTop(f)},cartQuantity:function(e){e=parseInt(e)||0,$("#hd-my-cart").find(".cart_quantity").text(e),$("#miniCartRightQty").length>0&&$("#miniCartRightQty").text(e)},miniCartViewNum:function(e){var t=0;e.status==1&&(t=e.info.miniCartSum,p.viewEvent.cartQuantity(t)),typeof send_to_campaign_cart_info=="function"&&send_to_campaign_cart_info()},miniCartView:function(e){if(e.status==0)var n={info:2};else{var i=e.info;if(e.status==1)if(!i||typeof i.cart_camp=="undefined"){var n={info:0};p.viewEvent.cartQuantity(0)}else{a=i.cart;var n={info:1,total:i.total,cart:i.cart_camp,shop_url:u};p.viewEvent.cartQuantity(i.total.qty)}}var s=d(),o=t.compile(s),f=o(n);$("#content_test").length>0?$("#content_test").html(f):$("#show_minicart").html(f),n.info==1&&i.cart_camp&&p.viewEvent.renderSupName(i.cart_camp),typeof send_to_campaign_cart_info=="function"&&send_to_campaign_cart_info(),r&&($("#miniCartRight").empty(),$("#minicart").clone(!0).appendTo($("#miniCartRight"))),p.init()},renderSupName:function(e){var t=[];$.isArray(e)&&$.each(e,function(e,n){$.isArray(n.info)&&n.info.length>0&&n.info[0].type==="0"&&n.info[0].itInType==="3"&&n.info[0].isFresh==="0"&&n.info[0].supSeq&&t.push(n.info[0].supSeq)}),t.length>0&&$.ajax({type:"GET",url:s+"commonApi/getSupNameList",dataType:"jsonp",data:{sup_seqs:JSON.stringify(t)},cache:!1,success:function(e){e.status==1&&e.data&&$.each(e.data,function(e,t){var n=$.trim(t.showSupName);n&&t.supSeq&&$('#minicart .packageTitle[data-sup-seq="'+t.supSeq+'"]').attr("title",n).text(n)})},error:function(){}})}},templateHelper:{getNumVali:function(e){return parseInt(e)<0?0:e},getTagList:function(e){var t="";return $.each(e,function(e,n){switch(n){case 1:t+='<span class="span_buyreduce">买立减</span>';break;case 2:t+='<span class="span_fresh">生鲜</span>';break;case 3:t+='<span class="span_package">加价购</span>';break;case 4:t+='<span class="span_gift">赠品</span>';break;case 5:t+='<span class="span_comb">组合</span>';break;case 6:t+='<span class="span_accessory">配件</span>';break;case 8:t+='<span class="span_package">优惠套餐</span>';break;case 10:t+='<span class="span_globalp"></span>';break;case 12:t+='<span class="span_group">团购</span>';break;case 13:t+='<span class="m-sp-col">礼品</span>';break;case 16:t+='<span class="span_comb">换购</span>'}}),t},getCampTypeTage:function(e){e=parseInt(e);var t="";switch(e){case 0:t="满减";break;case 1:t="满赠";break;case 2:t="限时活动";break;case 3:t="满赠";break;case 4:t="满减";break;case 5:t="折扣";break;case 6:t="折扣";break;case 7:t="满赠";break;case 8:t="折扣";break;case 9:t="优惠";break;case 10:t="优惠";break;case 11:t="优惠";break;case 12:t="优惠";break;case 13:t="换购";break;case 14:t="换购";break;default:t="优惠"}return"["+t+"]"},getSellingStatusWarning:function(e){var t="";e=parseInt(e);switch(e){case 1:t="商品下架";break;case 2:t="预购商品预购时间结束";break;case 3:t="商品已售罄";break;case 4:t="暂不配送";break;case 5:t="商品已删除";break;case 6:t="优惠已达上限";break;case 7:t="已赠完";break;case 8:t="企业用户不能购买商城商品";break;case 9:t="请先注册为母婴用户";break;case 10:t="您已领取过母婴0元商品";break;case 11:t="商品暂不出售";break;case 12:t="您已领取过睿仕汇开卡礼";break;case 13:t="商品需预约后购买";break;case 14:t="预售商品需单独购买";break;case 15:t="活动已终止";break;case 16:t="活动尚未开始";break;case 17:t="活动已结束";break;case 20:t="积分不足";break;case 21:t="会员等级未满足"}return t},getUlClass:function(e){var t;switch(e){case"plus":t="ul_plus";break;case"accessory":t="ul_accessory";break;case"comb":t="ul_comb";break;case"gift":t="ul_gift";break;default:t=""}return t},getUlConnectClass:function(e){return e==1?'<div class="connect"></div>':""}},viewAction:{mouseover:function(e){var t=p.utils.getCookie("cart_token");if(!t||!c||t!=c)c=t,p.ajaxEvent.showMiniCart();$("#show_minicart").show()},mouseleave:function(e){$("#show_minicart").hide()},click:function(){return window.location.href=u,!0}}};$(function(){t.helper("helperNumVali",p.templateHelper.getNumVali),t.helper("helperTagList",p.templateHelper.getTagList),t.helper("helperCampTypeTage",p.templateHelper.getCampTypeTage),t.helper("helperSellingStatusWarning",p.templateHelper.getSellingStatusWarning),t.helper("helperUlClass",p.templateHelper.getUlClass),t.helper("helperUlConnectClass",p.templateHelper.getUlConnectClass),$("#miniCartRight").length>0&&(r=!0,c=p.utils.getCookie("cart_token")),r?p.ajaxEvent.showMiniCart():p.ajaxEvent.showMiniCartNum(),i?$("#hd-my-cart").on("mouseover touchstart",".c-n,.c-num",p.viewAction.mouseover).on("mouseleave",p.viewAction.mouseleave).on("click touchstart",".c-n,.c-num",p.viewAction.click):$("#hd-my-cart").on("mouseover touchstart",".icon-cart-gwc,.icon-cart-hd",p.viewAction.mouseover).on("mouseleave",p.viewAction.mouseleave).on("click touchstart",".icon-cart-gwc,.icon-cart-hd",p.viewAction.click)});var b=['<div class="minicartContent" id="minicart">',"{{if info == 1}}",'<div class="mn-c-m oh">','<div class="mn-c-box J-sdb-cb js_cart_top">',"{{each cart as merchant}}",'<dl class="c-store mb15">','<dt class="c-store-tt fixed">','<a href="#" class="n fl packageTitle" alt="" title="{{merchant.info[0].merchantName}}" data-sup-seq="{{merchant.info[0].supSeq}}">',"{{merchant.info[0].merchantName}}","</a>","</dt>",'<dd class="c-list">',"{{each merchant.data as camp}}","{{if camp.info[0] != null}}",'<div class="c-prod">','<div class="c-sale-tip" class="js_no_camp_list" id="js_no_camp_{{camp.info[0].campId}}">','<div class="c-sale-b">','<span class="i">{{camp.info[0].type | helperCampTypeTage}}</span>','<span class="c">{{camp.info[0].camp_desc}}</span>',"</div>","</div>","{{/if}}","{{each camp.data as product productKey}}","{{if camp.info[0] == null}}",'<div class="c-prod">',"{{/if}}","{{each product as item itemKey}}",'<div class="c-item fixed {{if item.disable_reason }}c-soldout{{/if}} js_cart_pro_list" cart_id="{{item.cart_id}}">','{{if item.is_delete}}<a class="del js_delete"></a>{{/if}}','<p class="i fl mr5">','<a {{if item.source_url}}href="{{item.source_url}}"{{/if}} alt="" title=""><img src="{{item.it_pic}}" height="50" width="50" alt="" title=""></a>',"</p>",'<p class="n fl">','<a {{if item.source_url}}href="{{item.source_url}}"{{/if}} class="" alt="" title="">{{#item.tag_list | helperTagList}}{{item.name}}</a>',"</p>","{{if item.is_upd}}",'<p class="num fl js_mini_num">','<a href="javascript:void(0);" class="reduce {{if (item.disable_reason || item.qty <= 1 || item.kind == 15)}}reduce_gray{{/if}} fl" data-value="-1"></a>','<input type="text" autocomplete="off" value="{{item.qty}}" data-limit="{{item.max_buy_num}}" {{if item.is_prize== 1 || item.is_voucher_present== 1 || item.kind == 15}}disabled="disabled" {{/if}}>','<a href="javascript:void(0);" class="add {{if (item.disable_reason || item.qty >= item.max_buy_num || item.kind == 15)}}add_gray{{/if}} fr" data-value="1"></a>',"</p>","{{/if}}",'<p class="p fr mt5">',"{{if item.is_price}}<em>￥</em><span>{{item.price}}</span>{{/if}}","</p>","{{if item.integral_product_points > 0}}",'<p class="u-e-p">+<span>{{item.integral_product_points}}</span>积分</p>',"{{/if}}","{{if item.disable_reason}}",'<p class="out fr">{{item.disable_reason | helperSellingStatusWarning}}</p>',"{{/if}}","</div>","{{/each}}","{{if camp.info[0] == null}}","</div>","{{/if}}","{{/each}}","{{if camp.info[0] != null}}","</div>","{{/if}}","{{/each}}","</dd>","</dl>","{{/each}}","</div>",'<div class="mn-c-total">','<div class="c-t fixed">','<p class="t-n fl">','<span id="total_qty">{{total.qty}}</span>件',"</p>",'<p class="t-p fr">','<em>￥</em><span id="total_pay">{{total.total_pay}}</span>',"{{if total.total_score > 0}}",'<span class="u-e-p">+<em>{{total.total_score}}</em>积分</span>',"{{/if}}","</p>","</div>",'<div class="c-btn">','<a href="{{shop_url}}" alt="" title="">去购物车结算 &gt;&gt;</a>',"</div>","</div>","</div>","{{else}}",'<div class="empty-c">','<span class="ma"><i class="c-i oh"></i>购物车中没有飞牛商品哟！</span>',"</div>","{{/if}}","</div>"].join(""),w=['<div class="ui_poptip minicart minicartContent" id="minicart">','<input type="hidden" id="miniCartIsLoad" value="0">','<div class="ui_poptip_container">','<div class="ui_poptip_arrow poptip_up"></div>','<div class="ui_poptip_content">',"{{if info == 1}}",'<div class="mini_product">','<p class="mini_tit">最新加入商品</p>','<div class="cart_con js_cart_top">',"{{each cart as merchant}}","{{each merchant.data as camp}}","{{if camp.info[0] != null}}",'<div class="one_active js_no_camp_list" id="js_no_camp_{{camp.info[0].campId}}">','<ul class="ul_activity">',"<li>",'<p class="name"><strong>{{#camp.info[0].type | helperCampTypeTage}}</strong>{{camp.info[0].camp_desc}}</p>','<p class="subtotal">',"<span>小计：</span>",'<span class="price">','<em class="symbol">&yen;</em>','<span class="payable">{{camp.info[0].payable | helperNumVali}}</span>',"</span>","</p>","</li>","</ul>","{{/if}}","{{each camp.data as product product_index}}","{{if camp.info[0] == null}}",'<div class="one_active js_camp_list">',"{{/if}}","{{each product as item item_index}}",'<ul class="ul_product {{#item.mini_ul_class | helperUlClass}} {{if item.disable_reason}}ul_abnormal{{/if}} js_cart_pro_list" cart_id="{{item.cart_id}}">',"<li>{{#item.mini_ul_connect | helperUlConnectClass}}",'<a class="pdetail" {{if item.source_url}}href="{{item.source_url}}"{{/if}} >','<img src="{{item.it_pic}}"/>',"<p>",'<span class="name">{{#item.tag_list | helperTagList}}{{item.name}}</span>','{{if item.is_price}}<span class="price"><em class="symbol">&yen;</em>{{item.price}}</span>{{/if}}',"</p>",'<div class="mini_op">','<a class="delete js_delete" href="javascript:;">{{if item.is_delete}}删除{{/if}}</a>',"{{if item.is_upd}}",'<span class="mini_num js_mini_num">','<a href="javascript:;" class="reduce {{if (item.disable_reason || item.qty <= 1 || item.kind == 15)}}reduce_gray{{/if}}" data-value="-1"></a>','<input type="text" autocomplete="off" value="{{item.qty}}" data-limit="{{item.max_buy_num}}" {{if item.is_prize==1 || item.is_voucher_present== 1 || item.kind == 15}}disabled="disabled" {{/if}} />','<a href="javascript:;" class="add {{if (item.disable_reason || item.qty >= item.max_buy_num || item.kind == 15)}}add_gray{{/if}}" data-value="1"></a>',"</span>","{{/if}}","</div>","</li>","</ul>","{{/each}}","{{if camp.info[0] == null}}","</div>","{{/if}}","{{/each}}","{{if camp.info[0] != null}}","</div>","{{/if}}","{{/each}}","{{/each}}","</div>",'<div class="mini_total clearfix">','<p class="cart_num">共<span class="num" id="total_qty">{{total.qty}}</span>件商品</p>','<p class="cart_total"><span class="tit">共计</span><span class="price"><em class="symbol">&yen;</em><span id="total_pay">{{total.total_pay}}</span></span></p>',"</div>",'<p class="cart_bot">','<a class="cart_buy" href="{{shop_url}}">去购物车结算</a>',"</p>","</div>","{{else if info == 2}}",'<span class="nop refresh"><a class="r_btn" onclick="javascript:show_minicart();"></a>系统异常，请刷新</span>',"{{else}}",'<span class="nop emptycart">购物车中没有飞牛商品哟！</span>',"{{/if}}","</div>","</div>","</div>"].join("");window.addListToCart=v,window.parseSendDataToCart=y,window.modifyListToCart=m,window.deleteListToCart=g});